
在程序开发中，位于不同模块或不同文件中的全局变量、函数可能存在重名冲突。链接器有专门的符号决议规则来解决这种符号冲突，规则就是:
- 一山不容二虎。
- 强弱可以共存。
- 体积大者胜出。

编译器引入了强符号和弱符号的概念: 函数名、初始化的全局变量是强符号，而未初始化的全局变量则是弱符号。

在一个多文件的工程中，强符号是不允许多次定义，否则就会发生重定义错误。强符号和弱符号可以在一个项目中共存，当强弱符号共存时，强符号会覆盖掉弱符号，链接器会选择强符号作为可执行文件中的最终符号。
```c
  // sub.c
  int i = 20;
  // main.c
  int i;
  int main()
  {
    return 0;
  }
```
执行 `gcc main.c sub.c -o a.out` 可编译通过并运行。

链接器也允许一个项目中出现多个弱符号共存。在程序编译期间，编译器在分析每个文件中未初始化的全局变量时，并不知道该符号在链接阶段是被采用还是被丢弃，因此在程序编译期间，未初始化的全局变量并没有被直接放置在 BSS 段，而是将这些弱符号放到一个叫作 COMMON 的临时块中，在符号表中使用一个未定义的 COMMON 来标记，在目标文件中也没有给它们分配存储空间。在链接期间，链接器会比较多个文件中的弱符号，选择占用空间最大的那一个，作为可执行文件中的最终符号，此时弱符号的大小已经确定，并被直接放到了可执行文件的 BSS 段中。
```c
  // sub.c
  int i;
  // main.c
  char i;
  int main()
  {
    return 0;
  }
```

正常情况下，初始化的全局变量、函数名默认都是强符号，未初始化的全局变量默认是弱符号。如果在项目中有特殊需求，也可以将一些强符号显式转化为弱符号。

GNU C 编译器在 ASNI C 语法标准的基础上扩展了一系列 C 语言语法，如提供了一个 `__attribute__` 关键字用来声明符号的属性。通过下面的命令，可以将一个强符号转化为弱符号:
```c
  __attribute__((weak)) int n = 100;
  __attribute__((weak)) void func();
```
测试代码如下:
```c
  // sub.c
  int i = 20;
  // main.c
  __attribute__((weak)) int i = 10;
  int main()
  {
    return 0;
  }
```

和强符号、弱符号对应的，还有强引用、弱引用的概念。在一个程序中，可以定义多个函数和变量，变量名和函数名都是符号，这些符号的本质，或者说这些符号值，其实就是地址。在另一个文件中，可以通过函数名去调用该函数，通过变量名去访问该变量。这种通过符号去调用一个函数或访问一个变量的方式，通常称之为引用(reference)，强符号对应强引用，弱符号对应弱引用。

在程序链接过程中，若对一个符号的引用为强引用，链接时找不到其定义，链接器将会报未定义错误；若对一个符号的引用为弱引用，链接时找不到其定义，则链接器不会报错，不会影响最终可执行文件的生成。可执行文件在运行时如果没有找到该符号的定义才会报错。

利用链接器对弱引用的处理规则，在引用一个符号之前可以先判断该符号是否存在(定义)。这样当我们引用一个未定义的符号时，在链接阶段不会报错，在运行阶段通过判断运行，也可以避免运行错误。用法示例如下:
```c
  // decode.h
  __attribute__((weak)) void decode();
  // decode.c
  #include <stdio.h>
  __attribute__((weak)) void decode()
  {
    printf("lib:decode()\n");
  }
  // main.c
  #include <stdio.h>
  int main()
  {
    if (decode) {
      decode();
    }
    return 0;
  }
```
