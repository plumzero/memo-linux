
Linux 内存管理是一个复杂而高效的系统，负责管理物理内存和虚拟内存，确保系统稳定运行并优化性能。其主要组成部分和机制有:

### 核心概念

- 物理内存: 实际的RAM硬件资源。
- 虚拟内存: 为每个进程提供的抽象地址空间(通常是4GB或更大)，通过分页机制映射到物理内存或磁盘。
- 分页(Paging): 将内存划分为固定大小的块(通常4KB)，便于管理和交换到磁盘。
- 页面缓存(Page Cache): 将磁盘数据缓存到内存中，加速文件访问。

### 地址空间

- 用户空间: 每个进程独立拥有3GB(32位系统)的私有地址空间。
- 内核空间: 所有进程共享的1GB内核地址空间，存放内核代码和数据。

### 内存分配机制

- 伙伴系统(Buddy System): 管理物理页面的分配与释放，解决外部碎片问题。
- Slab分配器: 内核对象(如进程描述符)的高效分配，减少内部碎片。

### 虚拟内存管理

- 页表(Page Tables): 存储虚拟地址到物理地址的映射，由MMU(内存管理单元)转换。
- 多级页表: 减少页表内存占用(如四级页表: PGD→PUD→PMD→PTE)。
- TLB(Translation Lookaside Buffer): 缓存常用页表项，加速地址转换。

### 内存回收

- 页面置换: 当内存不足时，将不常用的页面换出到磁盘(swap分区或文件）。
- 回收算法
  - LRU(最近最少使用): 优先换出长时间未访问的页面。
  - kswapd: 内核守护进程，在后台回收内存。
  - OOM Killer: 内存严重不足时，强制终止占用内存最多的进程。

### 内核内存管理

- vmalloc: 分配虚拟地址连续但物理地址不一定连续的内存(用于大块内存)。
- kmalloc: 分配物理地址连续的内存(适合硬件访问)。
- 永久映射: 将高端内存(超过896MB的物理内存)映射到内核地址空间。

### 进程内存布局

每个进程的内存布局包括:
- 代码段(.text)
- 数据段(.data、.bss)
- 堆(Heap): 动态分配的内存(通过`malloc`增长)
- 栈(Stack):局部变量和函数调用信息
- 内存映射段(Memory Mapping Segment): 映射共享库或文件

### 共享内存

- 共享库: 多个进程共享相同的代码段(如glibc)
- System V 共享内存: 进程间通信的机制
- 共享内存映射: 通过`mmap`将文件映射到多个进程的地址空间

### 透明大页(Transparent Huge Pages，THP)

自动将多个普通页面（4KB）合并为大页（2MB），减少页表项和TLB压力，提升性能。

### 内存监控工具

- free: 查看物理内存和swap使用情况
- top/htop: 实时监控进程内存占用
- vmstat: 统计内存、swap、分页活动
- /proc/meminfo: 详细的内存使用信息
- smem: 分析实际物理内存使用(考虑共享内存)
